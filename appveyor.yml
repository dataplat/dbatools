# See http://www.appveyor.com/docs/appveyor-yml for many more options
image: Previous Visual Studio 2022
configuration: "Debug"

# skip PR builds when there's already a push build
skip_branch_with_pr: true

# skip builds on master branch (archival branch)
branches:
  except:
    - master

# skip tag commits entirely
skip_tags: true

skip_commits:
  files:
    - '**/*.md'
    - '.github/FUNDING.yml'
    - '.github/ISSUE_TEMPLATE/**'
    - '.github/PULL_REQUEST_TEMPLATE.md'
    - '.aider/**'
    - '.devcontainer/**'
    - '.vscode/**'
    - 'en-us/**'
  message: /\[skip ci\]/

build_script:
  - ps: Set-Service wuauserv -StartupType Manual #otherwise, choco command exits with code 1058

version: 2.1.{build}

cache:
  - C:\ProgramData\chocolatey\bin -> appveyor.yml
  - C:\ProgramData\chocolatey\lib -> appveyor.yml
  - C:\Program Files\WindowsPowerShell\Modules\PSScriptAnalyzer -> appveyor.yml
  - C:\Program Files\WindowsPowerShell\Modules\Pester -> appveyor.yml
  - C:\Program Files\WindowsPowerShell\Modules\dbatools.library -> .github/dbatools-library-version.json

#shallow_clone: true
clone_depth: 20

# Set build info
environment:
  environment: development
  version: 2.1.$(appveyor_build_number)
  appveyor_rdp_password: 2odCuiKmYiem

  matrix:
    - scenario: SINGLE
      part: 1/3
      InstanceSingle: sql2022
    - scenario: SINGLE
      part: 2/3
      InstanceSingle: sql2022
    - scenario: SINGLE
      part: 3/3
      InstanceSingle: sql2022
    - scenario: MULTI
      InstanceMulti1: sql2022
      InstanceMulti2: sql2017
    - scenario: COPY
      InstanceCopy1: sql2017
      InstanceCopy2: sql2022
    - scenario: HADR
      InstanceHadr: sql2022
    - scenario: RESTART
      InstanceRestart: sql2022
    - scenario: default
    # Unit tests only -- no SQL Server required, runs parameter validation for all commands
    - scenario: UNIT_TESTS_ONLY
    #- scenario: 2008R2SP2Express
    #  part: 1/2
    #  InstanceSingle: sql2008r2sp2
    #  InstanceMulti1: sql2008r2sp2
    #  InstanceMulti2: sql2017
    #  InstanceCopy1: sql2008r2sp2
    #  InstanceCopy2: sql2017
    #  InstanceRestart: sql2008r2sp2
    #  APPVEYOR_BUILD_WORKER_IMAGE: Previous Visual Studio 2015
    #- scenario: 2008R2SP2Express
    #  part: 2/2
    #  InstanceSingle: sql2008r2sp2
    #  InstanceMulti1: sql2008r2sp2
    #  InstanceMulti2: sql2017
    #  InstanceCopy1: sql2008r2sp2
    #  InstanceCopy2: sql2017
    #  InstanceHadr: sql2017
    #  InstanceRestart: sql2008r2sp2
    #  APPVEYOR_BUILD_WORKER_IMAGE: Previous Visual Studio 2015

# Set alternative clone folder
clone_folder: c:\github\dbatools

before_test:
  # turn tests directory (at least) to CRLF, as it's faster to do this on the zipball rather than checking out the repo
  - cmd: pushd C:\github\dbatools\tests & unix2dos -q  *.ps1 & popd
  # don't clown -- for some reason it's just not installing the library
  # dbatools.library is now installed via centralized method in appveyor.prep.ps1
  # grab appveyor lab files and needed requirements for tests in CI
  - ps: .\Tests\appveyor.prep.ps1

  # Setting up the local SQL Server environments
  - ps: .\Tests\appveyor.sqlserver.ps1
  #- ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

test_script:
   # Test with native PS version
  - ps: .\Tests\appveyor.pester.ps1

  # Collecting results
  - ps: .\Tests\appveyor.pester.ps1 -Finalize

after_test:
  - ps: .\Tests\appveyor.post.ps1

#on_finish:

#- ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
