name: VMSS Autoscaler

on:
  schedule:
    # Every 2 minutes - fast response, low cost
    - cron: '*/2 * * * *'
  workflow_dispatch:
  # Trigger on workflow run events for faster scaling
  workflow_run:
    workflows: ["CI Tests"]
    types: [requested, completed]

permissions:
  actions: read
  contents: read

jobs:
  scale:
    runs-on: ubuntu-latest
    steps:
      - name: Check queued and in-progress jobs
        id: queue
        run: |
          # Count queued jobs waiting for self-hosted runners
          QUEUED=$(gh api /repos/${{ github.repository }}/actions/runs \
            --jq '[.workflow_runs[] | select(.status == "queued" or .status == "in_progress")] | length')

          echo "Active workflows: $QUEUED"
          echo "queued_jobs=$QUEUED" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.VMSS_AZURE_CREDENTIALS }}

      - name: Calculate target capacity
        id: target
        run: |
          QUEUED=${{ steps.queue.outputs.queued_jobs }}

          # Each workflow has 10 jobs, scale to 5 runners for parallel execution
          # Limited by Azure quota: 20 cores / 4 cores per VM = 5 max VMs
          # If 1+ workflows: scale to 5 runners
          # If 0 workflows: scale to 0

          if [ $QUEUED -eq 0 ]; then
            TARGET=0
            echo "No active workflows - scaling to 0"
          elif [ $QUEUED -ge 1 ]; then
            TARGET=5
            echo "Active workflows detected - scaling to 5"
          fi

          echo "target_capacity=$TARGET" >> $GITHUB_OUTPUT

      - name: Get current VMSS capacity
        id: current
        run: |
          CURRENT=$(az vmss show \
            --resource-group dbatools-ci-runners \
            --name dbatools-runner-vmss \
            --query sku.capacity \
            -o tsv)

          echo "Current capacity: $CURRENT"
          echo "current_capacity=$CURRENT" >> $GITHUB_OUTPUT

      - name: Scale VMSS if needed
        run: |
          CURRENT=${{ steps.current.outputs.current_capacity }}
          TARGET=${{ steps.target.outputs.target_capacity }}

          if [ "$CURRENT" != "$TARGET" ]; then
            echo "ðŸ“Š Scaling VMSS: $CURRENT â†’ $TARGET instances"

            az vmss scale \
              --resource-group dbatools-ci-runners \
              --name dbatools-runner-vmss \
              --new-capacity $TARGET

            echo "âœ… Scaled successfully"
          else
            echo "âœ“ Already at target capacity ($TARGET)"
          fi

      - name: Summary
        run: |
          echo "## Autoscaler Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Queued Workflows:** ${{ steps.queue.outputs.queued_jobs }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Capacity:** ${{ steps.current.outputs.current_capacity }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Capacity:** ${{ steps.target.outputs.target_capacity }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
